@page "/"
@using Microsoft.AspNetCore.SignalR.Client
@inject NavigationManager Navigation
@implements IAsyncDisposable

<PageTitle>Battleship</PageTitle>

@if ((currentGameState == GameState.Initial) || userInput == "")
{
    <div class="form-group">
        <label>
            Enter your name:
            <input @bind="userInput" />
        </label>
        <button class="play-buton" @onclick="(() => {currentGameState = GameState.Setup;})">Play</button>
    </div>
}

@if (userInput != "" && (currentGameState == GameState.Setup || currentGameState == GameState.Playing))
{
    <div class="user-board">
        <h3>@(currentGameState == GameState.Setup ? "Place your ships!" : "Your Board")</h3>

        <div>
            <button @onclick="ToggleShipOrientation">@((isShipHorizontal ? "Horizontal" : "Vertical") + " Placement")</button>
        </div>

        @for (int y = 0; y < 10; y++)
        {
            <div class="row">
                @for (int x = 0; x < 10; x++)
                {
                    int xCoord = x;//Capturing the x and Y coordinates so that their values at button creation are preserved.
                    int yCoord = y;
                    <button class="@(GetCellClass(xCoord, yCoord))" 
                    @onclick='(() => { if(currentGameState == GameState.Setup) PlaceShip(xCoord, yCoord, isShipHorizontal);})'
                    @onmouseover='(() => {if(currentGameState == GameState.Setup) ShowShipPreview(xCoord, yCoord, isShipHorizontal); })'
                    @onmouseout='(() => { if(currentGameState == GameState.Setup) HideShipPreview(xCoord, yCoord, isShipHorizontal); })'
                    ></button>
                }
            </div>
        }

        @if (currentGameState == GameState.Setup)
        {
            <button class="square" @onclick="(() => { currentGameState = GameState.Playing; })">Start Game</button>
        }
    </div>
}

@if (currentGameState == GameState.Playing)
{
    <div class="player-boards">
        <div class="opponent-board">
            <h3>Opponent's Board</h3>
            @for (int y = 0; y < 10; y++)
            {
                <div class="row">
                    @for (int x = 0; x < 10; x++)
                    {
                        int xCoord = x;//Capturing x and y coordinates so that their values at button creation are preserved.
                        int yCoord = y;
                        <button class="@(OpponentBoardInfo(xCoord, yCoord))" @onclick='(() => {
                            SetCoordinates(xCoord, yCoord);                            
                        })'></button>
                    }
                </div>
                }
            }
        </div>

        <!-- Display selected coordinates in a text box -->
        <div class="fire-control">
            <button @onclick="Fire" disabled="@(currentGameState == GameState.Waiting || !coordinates.HasValue)">Fire</button>

            <!-- Display current selected coordinates -->
            <input type="text" value="@GetCoordinatesText()" readonly style="margin-left: 10px; width: 100px;" />
        </div>

        <ul id="messagesList">
        @foreach (var move in moves)
        {
            <li>@move</li>
        }
        </ul>
    </div>
}


@code {
    #region Declarations
    #region Connection Information
    private HubConnection? hubConnection;
    public bool IsConnected => hubConnection?.State == HubConnectionState.Connected;
    #endregion
    #region Player Information
    private List<string> moves = new List<string>();
    private string? userInput = "";
    private (int x,int y)? coordinates;
    #endregion
    #region Boards
    // Game board tracking (10x10 grids for both players)
    private bool[,] playerBoard = new bool[10, 10]; // Stores player's ships
    private bool[,] previewBoard = new bool[10, 10]; // Stores ship previews
    private bool[,] opponentShots = new bool[10, 10]; // Stores the opponents previous shots

    private bool[,] opponentBoard = new bool[10,10]; // Stores hits/misses on opponent
    private bool[,] opponentDefaultBoard = new bool[10, 10]; // A default state for the opponents board when neither hit nor miss is recorded
    #endregion
    #region Game State Info
    private enum GameState { Initial, Setup, Playing, Waiting, GameOver }
    private GameState currentGameState = GameState.Initial;
    private string currentPlayer = "";
    private string opponent = "";
    #endregion
    #region Ship Parameters
    private bool isShipHorizontal = true; // To manage ship placement direction
    private int shipCount = 0;
    private int shipLimit = 3;
    #endregion
    #endregion

    #region Modifier Functions
    private void SetCoordinates(int x, int y) //Sets the value of the coordinates tuple for later use
    {
        coordinates = (x, y);
    }
    private void ToggleShipOrientation() //Toggle ship orientation boolean to track whether or not a placed ship is vertical or horizontal
    {
        isShipHorizontal = !isShipHorizontal;
    }

    #region Board Modification
    #region Player Board
    private string GetCellClass(int x, int y)
    {
        /*Changes the type of grid space depending on whether or not a ship is currently there.
         * Effectively this allows for the preview to not override existing ships on the setup board.
        */
        if (playerBoard[x, y] && !opponentShots[x,y])//If there is a ship on this space and the opponent has not shot here yet
        {
            return "ship";//The space is of type ship
        }
        else if(playerBoard[x, y] && opponentShots[x,y])//If there is a ship on this space, and the opponent has shot here
        {
            return "hit";//The ship has been destroyed
        }
        else if(!playerBoard[x, y] && opponentShots[x,y])//If the opponent has shot a tile that does not have a ship on it
        {
            return "miss";//The opponent has missed
        }
        else if (previewBoard[x, y])//If the space has a preview of a ship
        {
            return "preview";//The space is of type preview
        }
        else//If none are true
        {
            return "square";//The space is blank
        }
    }

    private void ShowShipPreview(int startX, int startY, bool isHorizontal)
    {
        int shipLength = shipCount + 1;
        if (isHorizontal)
        {
            for (int i = 0; i < shipLength; i++)
            {
                if (startX + i < 10)
                {
                    previewBoard[startX + i, startY] = true;
                }
            }
        }
        else
        {
            for (int i = 0; i < shipLength; i++)
            {
                if (startY + i < 10)
                {
                    previewBoard[startX, startY + i] = true;
                }
            }
        }
    }

    private void HideShipPreview(int startX, int startY, bool isHorizontal)
    {
        int shipLength = shipCount + 1;
        if (isHorizontal)
        {
            for (int i = 0; i < shipLength; i++)
            {
                if (startX + i < 10)
                {
                    previewBoard[startX + i, startY] = false;
                }
            }
        }
        else
        {
            for (int i = 0; i < shipLength; i++)
            {
                if (startY + i < 10)
                {
                    previewBoard[startX, startY + i] = false;
                }
            }
        }
    }

    private void PlaceShip(int startX, int startY, bool isHorizontal)
    {
        int shipLength = shipCount + 1;
        if (isHorizontal)
        {
            if (startX + shipLength <= 10)
            {
                for (int i = 0; i < shipLength; i++)
                {
                    playerBoard[startX + i, startY] = true;
                }
                shipCount++;
            }
        }
        else
        {
            if (startY + shipLength <= 10)
            {
                for (int i = 0; i < shipLength; i++)
                {
                    playerBoard[startX, startY + i] = true;
                }
                shipCount++;
            }
        }
        if (shipCount >= shipLimit)
        {
            currentGameState = GameState.Playing;
        }
    }
    #endregion
    #region Opponent Board
    private string OpponentBoardInfo(int x, int y)
    {
        if(opponentDefaultBoard[x,y] && opponentBoard[x,y])
        {
            return "hit";
        }
        else if(opponentDefaultBoard[x,y] && !opponentBoard[x,y])
        {
            return "miss";
        }
        else
        {
            return "square";
        }
    }
    #endregion
    #endregion
    #endregion

    #region Networking Functionality
    //  runs when client connects
    protected override async Task OnInitializedAsync()
    {
        // create a new connection to the hub
        hubConnection = new HubConnectionBuilder()
            .WithUrl(Navigation.ToAbsoluteUri("/chathub"))
            .WithAutomaticReconnect()
            .Build();

        // when a user and message are received from the connection...
        hubConnection.On<string, int ,int>("ReceiveCoordinates", (user, x, y) =>
        {
            opponentShots[x, y] = true;

            hubConnection.SendAsync("SendHitMiss", playerBoard[x, y]);
            var formattedMessage = $"{user} fires at {x} , {y}";
            moves.Add(formattedMessage);
            InvokeAsync(StateHasChanged);
        });

        hubConnection.On<bool>("ShotResponse", (wasHit) =>
        {
            string message;

            if (wasHit)
            {
                message = $"Your Shot at {coordinates} was a hit!";
                opponentBoard[coordinates.Value.x, coordinates.Value.y] = true;
                opponentDefaultBoard[coordinates.Value.x, coordinates.Value.y] = true;
                // Update board status for hit
            }
            else
            {
                message = $" Your Shot at {coordinates} was a miss!";
                opponentDefaultBoard[coordinates.Value.x, coordinates.Value.y] = true;
            }
            // Check if all ships are sunk for game over condition
            var formattedMessage = message;
            moves.Add(formattedMessage);
            InvokeAsync(StateHasChanged);
        });

        await hubConnection.StartAsync();
    }

    private async Task Fire()
    {
        if (hubConnection is not null && coordinates.HasValue)
        {
            await hubConnection.SendAsync("SendCoordinates", userInput, coordinates.Value.x, coordinates.Value.y);
            currentGameState = GameState.Playing;
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection is not null)
        {
            await hubConnection.DisposeAsync();
        }
    }

    #endregion

    #region Accessor Functions
    // Helper function to display the selected coordinates in the text box
    private string GetCoordinatesText()
    {
        return coordinates.HasValue ? $"({coordinates})" : "None";
    }
    #endregion
//End C# code
}
